<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>–°–ø–∏—Å–æ–∫ –±–∏–ª–µ—Ç–æ–≤</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
  <style>
    body {
        background-color: #f8f9fa;
        padding: 0;
        margin: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

        nav {
            background: linear-gradient(135deg, #343a40, #495057);
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        nav a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1.5rem;
            margin: 0 0.5rem;
            border-radius: 5px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        nav a:hover {
            background-color: rgba(255,255,255,0.1);
            transform: translateY(-2px);
        }

    .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 20px;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e9ecef;
    }

    h1 {
        margin-bottom: 20px;
        color: #343a40;
        font-size: 1.8rem;
    }

    .btn {
        padding: 10px 20px;
        border-radius: 5px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        text-decoration: none;
        display: inline-block;
        text-align: center;
        font-size: 0.9rem;
    }

    .btn-primary {
        background: linear-gradient(135deg, #d63384, #c2185b);
        color: white !important;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #c2185b, #ad1457);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(214, 51, 132, 0.3);
    }

    .btn-secondary {
        background: linear-gradient(135deg, #6c757d, #545b62);
        color: white !important;
    }

    .btn-secondary:hover {
        background: linear-gradient(135deg, #545b62, #3d4246);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(108,117,125,0.3);
    }

    .btn-warning {
        background: linear-gradient(135deg, #ffc107, #e0a800);
        color: #212529 !important;
    }

    .btn-warning:hover {
        background: linear-gradient(135deg, #e0a800, #d39e00);
    }

    .btn-danger {
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: white !important;
    }

    .btn-danger:hover {
        background: linear-gradient(135deg, #c82333, #bd2130);
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ö–µ–º—ã –∑–∞–ª–∞ */
    .hall-layout {
        text-align: center;
        margin: 20px 0;
        padding: 30px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-left: 4px solid #d63384;
    }

    .screen {
        background: linear-gradient(135deg, #d63384, #e685b5);
        color: white;
        padding: 20px;
        margin: 0 auto 40px auto;
        border-radius: 10px;
        width: 70%;
        font-weight: bold;
        font-size: 1.2rem;
        box-shadow: 0 4px 15px rgba(214, 51, 132, 0.3);
    }

    .seating-grid {
        display: inline-block;
        margin-bottom: 30px;
    }

    .seat-row {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        justify-content: center;
    }

    .row-number {
        width: 60px;
        font-weight: bold;
        color: #495057;
        margin-right: 15px;
        font-size: 0.9rem;
    }

    .seat {
        width: 40px;
        height: 40px;
        margin: 3px;
        background: #28a745;
        color: white;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: bold;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }

    .seat.available:hover {
        background: #218838;
        transform: scale(1.15);
        border-color: #d63384;
        box-shadow: 0 2px 8px rgba(214, 51, 132, 0.4);
    }

    .seat.occupied {
        background: #dc3545;
        cursor: not-allowed;
        opacity: 0.7;
    }

    .seat.selected {
        background: #d63384;
        transform: scale(1.15);
        border-color: #c2185b;
        box-shadow: 0 2px 10px rgba(214, 51, 132, 0.5);
    }

    .seat-info {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #d63384;
    }

    .stats-card {
        background: white;
        border-radius: 10px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-left: 4px solid #d63384;
    }

    .filter-section {
        background: white;
        padding: 25px;
        border-radius: 10px;
        margin-bottom: 25px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-left: 4px solid #6c757d;
    }

    .session-info {
        background: linear-gradient(135deg, #d63384, #e685b5);
        color: white;
        padding: 25px;
        border-radius: 10px;
        margin-bottom: 25px;
        box-shadow: 0 4px 15px rgba(214, 51, 132, 0.3);
    }

    .price-breakdown {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        border-left: 3px solid #d63384;
    }

    .alert {
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 25px;
        border: none;
    }

    .alert-success {
        background-color: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
    }

    .alert-danger {
        background-color: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
    }

    .alert-info {
        background-color: #d1ecf1;
        color: #0c5460;
        border-left: 4px solid #17a2b8;
    }

    .table {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .table thead th {
        background: linear-gradient(135deg, #d63384, #e685b5);
        color: white;
        border: none;
        padding: 15px;
        font-weight: 600;
    }

    .table tbody tr:hover {
        background-color: rgba(214, 51, 132, 0.05);
    }

    .badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 500;
    }

    .bg-success {
        background: linear-gradient(135deg, #28a745, #20c997) !important;
    }

    .bg-warning {
        background: linear-gradient(135deg, #ffc107, #fd7e14) !important;
    }

    .bg-info {
        background: linear-gradient(135deg, #17a2b8, #6f42c1) !important;
    }

    .form-select:focus,
    .form-control:focus {
        border-color: #d63384;
        box-shadow: 0 0 0 0.2rem rgba(214, 51, 132, 0.25);
    }

    .modal-header {
        background: linear-gradient(135deg, #d63384, #e685b5);
        color: white;
        border-bottom: none;
    }

    .modal-footer {
        border-top: 1px solid #e9ecef;
        padding: 20px;
    }

    .price-display {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #d63384;
    }

    @media (max-width: 768px) {
        .container {
            padding: 20px;
        }

        nav {
            text-align: center;
        }

        nav a {
            display: inline-block;
            margin: 5px;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        .screen {
            width: 90%;
            padding: 15px;
            font-size: 1rem;
        }

        .seat {
            width: 35px;
            height: 35px;
            font-size: 0.7rem;
        }

        .row-number {
            width: 50px;
            font-size: 0.8rem;
        }
    }
  </style>
</head>
<body>
<nav>
  <a href="/films">–§–∏–ª—å–º—ã</a>
  <a href="/halls">–ó–∞–ª—ã</a>
  <a href="/sessions">–°–µ–∞–Ω—Å—ã</a>
  <a href="/tickets">–ë–∏–ª–µ—Ç—ã</a>
  <a href="/orders" class="active">–ó–∞–∫–∞–∑—ã</a>
  <a href="/users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
</nav>

<div class="container mt-4">
  <h1 class="mb-4">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∏–ª–µ—Ç–∞–º–∏</h1>

  <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Å–µ–∞–Ω—Å–∞–º -->
  <div class="filter-section">
    <form method="get" th:action="@{/tickets}">
      <div class="row">
        <div class="col-md-6">
          <label for="sessionSelect" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–∞–Ω—Å:</label>
          <select id="sessionSelect" name="sessionId" class="form-select" onchange="this.form.submit()">
            <option value="">–í—Å–µ —Å–µ–∞–Ω—Å—ã</option>
            <option th:each="cinemaSessionItem : ${cinemaSessions}"
                    th:value="${cinemaSessionItem.sessionId}"
                    th:text="${cinemaSessionItem.film.name + ' - ' + cinemaSessionItem.date + ' ' + cinemaSessionItem.startTime + ' (–ó–∞–ª ' + cinemaSessionItem.hall.hallId + ')'}"
                    th:selected="${selectedSessionId == cinemaSessionItem.sessionId}">
            </option>
          </select>
        </div>
      </div>
    </form>
  </div>

  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div th:if="${stats}" class="stats-card">
    <h5>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ–∞–Ω—Å–∞</h5>
    <div class="row">
      <div class="col-md-3">
        <strong>–í—Å–µ–≥–æ –º–µ—Å—Ç:</strong> <span th:text="${stats.totalSeats}">0</span>
      </div>
      <div class="col-md-3">
        <strong>–ö—É–ø–ª–µ–Ω–æ:</strong> <span th:text="${stats.purchasedTickets}">0</span>
      </div>
      <div class="col-md-3">
        <strong>–°–≤–æ–±–æ–¥–Ω–æ:</strong> <span th:text="${stats.availableSeats}">0</span>
      </div>
      <div class="col-md-3">
        <strong>–ó–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç—å:</strong>
        <span th:text="${#numbers.formatDecimal(stats.occupancyRate, 1, 2)} + '%'">0%</span>
      </div>
    </div>
  </div>

  <!-- –°—Ö–µ–º–∞ –∑–∞–ª–∞ -->
  <div th:if="${seatingChart != null}">
    <div class="session-info">
      <h4 th:text="'–°–µ–∞–Ω—Å: ' + ${cinemaSession.film.name} + ' - ' + ${cinemaSession.date} + ' ' + ${cinemaSession.startTime}"></h4>
      <p th:text="'–ó–∞–ª: ' + ${cinemaSession.hall.hallId} + ' | –í—Å–µ–≥–æ –º–µ—Å—Ç: ' + ${cinemaSession.hall.numberSeats}"></p>
      <p th:if="${cinemaSession.cost != null}"
         th:text="'–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞: ' + ${#numbers.formatDecimal(cinemaSession.cost, 1, 'DEFAULT', 2, 'DEFAULT')} + ' ‚ÇΩ'"></p>
    </div>

    <div class="hall-layout">
      <div class="screen">üé¨ –≠–ö–†–ê–ù üé¨</div>

      <!-- –õ–µ–≥–µ–Ω–¥–∞ -->
      <div class="row justify-content-center mb-3">
        <div class="col-auto">
          <div class="d-flex align-items-center">
            <div class="seat available me-2"></div>
            <span>–°–≤–æ–±–æ–¥–Ω–æ</span>
          </div>
        </div>
        <div class="col-auto">
          <div class="d-flex align-items-center">
            <div class="seat occupied me-2"></div>
            <span>–ó–∞–Ω—è—Ç–æ</span>
          </div>
        </div>
        <div class="col-auto">
          <div class="d-flex align-items-center">
            <div class="seat selected me-2"></div>
            <span>–í—ã–±—Ä–∞–Ω–æ</span>
          </div>
        </div>
      </div>

      <div class="seating-grid">
        <div th:each="rowEntry : ${seatingChart}" class="seat-row">
          <div class="row-number">–†—è–¥ [[${rowEntry.key}]]</div>
          <div th:each="ticket : ${rowEntry.value}"
               class="seat"
               th:classappend="${ticket.isPurchased} ? 'occupied' : 'available'"
               th:attr="data-ticketid=${ticket.ticketId},
                        data-row=${ticket.row},
                        data-seat=${ticket.seat},
                        data-sessionid=${ticket.session.sessionId}"
               th:onclick="${ticket.isPurchased} ? '' : 'selectSeat(this)'">
            [[${ticket.seat}]]
          </div>
        </div>
      </div>

      <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –º–µ—Å—Ç–µ -->
      <div id="selectedSeatInfo" class="seat-info" style="display: none;">
        <h5>–í—ã–±—Ä–∞–Ω–æ –º–µ—Å—Ç–æ: <span id="selectedSeatText"></span></h5>
        <div class="price-info">
          <p class="mb-1">–¶–µ–Ω–∞:
            <span id="basePriceDisplay" class="text-muted"></span>
            <span id="finalPriceDisplay" class="fw-bold fs-5 ms-2"></span>
          </p>
          <div id="discountDetails" class="price-breakdown"></div>
        </div>
        <button type="button" class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#purchaseModal">
          –ö—É–ø–∏—Ç—å –±–∏–ª–µ—Ç
        </button>
      </div>
    </div>
  </div>

  <!-- –¢–∞–±–ª–∏—Ü–∞ –±–∏–ª–µ—Ç–æ–≤ (–¥–ª—è –≤—Å–µ—Ö —Å–µ–∞–Ω—Å–æ–≤ –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ) -->
  <div th:if="${selectedSessionId == null}">
    <h3 class="mb-3">–í—Å–µ –±–∏–ª–µ—Ç—ã</h3>
    <div class="table-responsive">
      <table class="table table-striped">
        <thead class="table-dark">
        <tr>
          <th>ID –ë–∏–ª–µ—Ç–∞</th>
          <th>–°–µ–∞–Ω—Å</th>
          <th>Email –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</th>
          <th>–†—è–¥</th>
          <th>–ú–µ—Å—Ç–æ</th>
          <th>–¶–µ–Ω–∞</th>
          <th>–°–∫–∏–¥–∫–∞</th>
          <th>–°—Ç–∞—Ç—É—Å</th>
          <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="ticket : ${tickets}">
          <td th:text="${ticket.ticketId}"></td>
          <td th:text="${ticket.session != null ? ticket.session.film.name + ' - ' + ticket.session.date + ' ' + ticket.session.startTime + ' - –ó–∞–ª: ' + ticket.session.hall.hallId : '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Å—Å–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞'}"></td>
          <td th:text="${ticket.user != null ? ticket.user.email : '–ù–µ –∫—É–ø–ª–µ–Ω'}"></td>
          <td th:text="${ticket.row}"></td>
          <td th:text="${ticket.seat}"></td>
          <td>
            <span th:if="${ticket.session != null && ticket.session.cost != null}">
              <span th:text="${#numbers.formatDecimal(ticket.finalPrice, 1, 'DEFAULT', 2, 'DEFAULT') + ' ‚ÇΩ'}"></span>
              <small th:if="${ticket.discount != null and ticket.discount.name() != 'NO_DISCOUNT'}"
                     class="text-muted d-block">
                (–±–∞–∑–æ–≤–∞—è: [[${#numbers.formatDecimal(ticket.session.cost, 1, 'DEFAULT', 2, 'DEFAULT')}]] ‚ÇΩ)
              </small>
            </span>
            <span th:unless="${ticket.session != null && ticket.session.cost != null}" class="text-muted">
              –ù–µ —É–∫–∞–∑–∞–Ω–∞
            </span>
          </td>
          <td>
            <span th:if="${ticket.discount != null}"
                  th:text="${ticket.discount.label}"
                  class="badge bg-info">
            </span>
            <span th:unless="${ticket.discount != null}" class="badge bg-secondary">–ù–µ—Ç —Å–∫–∏–¥–∫–∏</span>
          </td>
          <td>
            <span th:if="${ticket.isPurchased}" class="badge bg-success">–ö—É–ø–ª–µ–Ω</span>
            <span th:unless="${ticket.isPurchased}" class="badge bg-warning">–°–≤–æ–±–æ–¥–µ–Ω</span>
          </td>
          <td>
            <div th:if="${ticket.isPurchased}">
              <form th:action="@{/tickets/cancel}" method="post" class="d-inline">
                <input type="hidden" name="ticketId" th:value="${ticket.ticketId}"/>
                <button type="submit" class="btn btn-warning btn-sm"
                        onclick="return confirm('–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–∫—É–ø–∫—É —ç—Ç–æ–≥–æ –±–∏–ª–µ—Ç–∞?')">
                  –û—Ç–º–µ–Ω–∏—Ç—å
                </button>
              </form>
            </div>
            <div th:unless="${ticket.isPurchased}">
              <span class="text-muted">–°–≤–æ–±–æ–¥–µ–Ω</span>
            </div>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± —É—Å–ø–µ—Ö–µ/–æ—à–∏–±–∫–µ -->
  <div th:if="${param.success}" class="alert alert-success alert-dismissible fade show">
    <span>–ë–∏–ª–µ—Ç —É—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω!</span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>

  <div th:if="${param.error}" class="alert alert-danger alert-dismissible fade show">
    <span th:text="${param.error}">–û—à–∏–±–∫–∞!</span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ -->
<div class="modal fade" id="purchaseModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form th:action="@{/tickets/purchase}" method="post">
        <input type="hidden" name="ticketId" id="purchaseTicketId">

        <div class="modal-header">
          <h5 class="modal-title">–ü–æ–∫—É–ø–∫–∞ –±–∏–ª–µ—Ç–∞</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div id="modalSeatInfo" class="alert alert-info"></div>

          <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ü–µ–Ω—ã -->
          <div class="mb-3">
            <label class="form-label fw-bold">–°—Ç–æ–∏–º–æ—Å—Ç—å –±–∏–ª–µ—Ç–∞:</label>
            <div class="price-display">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span>–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞:</span>
                <span id="modalBasePrice" class="text-muted"></span>
              </div>
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span>–°–∫–∏–¥–∫–∞:</span>
                <span id="modalDiscount" class="text-success"></span>
              </div>
              <hr>
              <div class="d-flex justify-content-between align-items-center">
                <span class="fw-bold">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</span>
                <span id="modalFinalPrice" class="fw-bold fs-4 text-primary"></span>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label for="userEmail" class="form-label">Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
            <select id="userEmail" name="userEmail" class="form-select" required>
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>
              <option th:each="user : ${users}"
                      th:value="${user.email}"
                      th:text="${user.email + ' (' + user.name + ')'}">
              </option>
            </select>
          </div>

          <div class="mb-3">
            <label for="discountType" class="form-label">–¢–∏–ø —Å–∫–∏–¥–∫–∏:</label>
            <select id="discountType" name="discountType" class="form-select" onchange="updateFinalPrice()">
              <option th:each="type : ${discountTypes}"
                      th:value="${type}"
                      th:text="${type.label}">
              </option>
            </select>
          </div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–∫—É–ø–∫—É</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
  let selectedSeat = null;
  let currentBasePrice = 0;

  // Factory Method –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å–∫–∏–¥–∫–∏ –≤ JavaScript
  const discountCalculator = {
    calculatePrice: function(basePrice, discountType) {
      let multiplier = 1.0;
      let discountName = "–ë–µ–∑ —Å–∫–∏–¥–∫–∏";
      let discountPercent = 0;

      switch(discountType) {
        case 'CHILD_DISCOUNT':
          multiplier = 0.5;
          discountName = "–î–µ—Ç—Å–∫–∞—è —Å–∫–∏–¥–∫–∞";
          discountPercent = 50;
          break;
        case 'STUDENT_DISCOUNT':
          multiplier = 0.7;
          discountName = "–°—Ç—É–¥–µ–Ω—á–µ—Å–∫–∞—è —Å–∫–∏–¥–∫–∞";
          discountPercent = 30;
          break;
        case 'SENIOR_DISCOUNT':
          multiplier = 0.8;
          discountName = "–ü–µ–Ω—Å–∏–æ–Ω–Ω–∞—è —Å–∫–∏–¥–∫–∞";
          discountPercent = 20;
          break;
        case 'NO_DISCOUNT':
        default:
          multiplier = 1.0;
          discountName = "–ë–µ–∑ —Å–∫–∏–¥–∫–∏";
          discountPercent = 0;
          break;
      }

      const finalPrice = basePrice * multiplier;
      const discountAmount = basePrice - finalPrice;

      return {
        basePrice: basePrice,
        finalPrice: finalPrice,
        discountName: discountName,
        discountPercent: discountPercent,
        discountAmount: discountAmount,
        multiplier: multiplier
      };
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ –º–µ—Å—Ç–∞
  function selectSeat(element) {
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
    if (selectedSeat) {
      selectedSeat.classList.remove('selected');
      selectedSeat.classList.add('available');
    }

    // –í—ã–¥–µ–ª—è–µ–º –Ω–æ–≤–æ–µ –º–µ—Å—Ç–æ
    element.classList.remove('available');
    element.classList.add('selected');
    selectedSeat = element;

    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–µ—Å—Ç–µ
    const row = element.getAttribute('data-row');
    const seat = element.getAttribute('data-seat');
    const ticketId = element.getAttribute('data-ticketid');

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
    document.getElementById('selectedSeatText').textContent = `–†—è–¥ ${row}, –ú–µ—Å—Ç–æ ${seat}`;
    document.getElementById('purchaseTicketId').value = ticketId;
    document.getElementById('modalSeatInfo').textContent = `–†—è–¥ ${row}, –ú–µ—Å—Ç–æ ${seat}`;

    // –ü–æ–ª—É—á–∞–µ–º –±–∞–∑–æ–≤—É—é —Ü–µ–Ω—É –∏–∑ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∞–Ω—Å–∞
    const basePriceElement = document.querySelector('[th\\:text*="–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞"]');
    if (basePriceElement) {
      const priceText = basePriceElement.textContent;
      const priceMatch = priceText.match(/(\d+[.,]\d+)/);
      if (priceMatch) {
        currentBasePrice = parseFloat(priceMatch[1].replace(',', '.'));
      }
    }

    // –ï—Å–ª–∏ —Ü–µ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–µ–∞–Ω—Å–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    if (!currentBasePrice || isNaN(currentBasePrice)) {
      currentBasePrice = 500; // –¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ü–µ–Ω—ã
    updatePriceDisplay();

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    document.getElementById('selectedSeatInfo').style.display = 'block';
  }

  // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–Ω—ã
  function updateFinalPrice() {
    updatePriceDisplay();
  }

  // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ü–µ–Ω—ã
  function updatePriceDisplay() {
    const discountType = document.getElementById('discountType').value;
    const priceInfo = discountCalculator.calculatePrice(currentBasePrice, discountType);

    // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    document.getElementById('modalBasePrice').textContent = priceInfo.basePrice.toFixed(2) + ' ‚ÇΩ';
    document.getElementById('modalFinalPrice').textContent = priceInfo.finalPrice.toFixed(2) + ' ‚ÇΩ';

    if (priceInfo.discountPercent > 0) {
      document.getElementById('modalDiscount').textContent = `-${priceInfo.discountPercent}% (${priceInfo.discountAmount.toFixed(2)} ‚ÇΩ)`;
      document.getElementById('modalDiscount').className = 'text-success';
    } else {
      document.getElementById('modalDiscount').textContent = '0%';
      document.getElementById('modalDiscount').className = 'text-muted';
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    document.getElementById('basePriceDisplay').textContent = priceInfo.basePrice.toFixed(2) + ' ‚ÇΩ';
    document.getElementById('finalPriceDisplay').textContent = priceInfo.finalPrice.toFixed(2) + ' ‚ÇΩ';

    let discountHtml = '';
    if (priceInfo.discountPercent > 0) {
      discountHtml = `
        <div class="d-flex justify-content-between">
          <span>–°–∫–∏–¥–∫–∞ (${priceInfo.discountPercent}%):</span>
          <span class="text-success">-${priceInfo.discountAmount.toFixed(2)} ‚ÇΩ</span>
        </div>
        <div class="text-success small mt-1">
          <i>${priceInfo.discountName}</i>
        </div>
      `;
    } else {
      discountHtml = '<div class="text-muted small">–ë–µ–∑ —Å–∫–∏–¥–∫–∏</div>';
    }

    document.getElementById('discountDetails').innerHTML = discountHtml;

    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–≥–æ–¥—ã
    if (priceInfo.discountPercent > 0) {
      document.getElementById('finalPriceDisplay').classList.add('text-success');
    } else {
      document.getElementById('finalPriceDisplay').classList.remove('text-success');
    }
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  document.addEventListener('DOMContentLoaded', function() {
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    const purchaseModal = document.getElementById('purchaseModal');
    if (purchaseModal) {
      purchaseModal.addEventListener('show.bs.modal', function() {
        updatePriceDisplay();
      });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ü–µ–Ω—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const basePriceElement = document.querySelector('[th\\:text*="–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞"]');
    if (basePriceElement) {
      const priceText = basePriceElement.textContent;
      const priceMatch = priceText.match(/(\d+[.,]\d+)/);
      if (priceMatch) {
        currentBasePrice = parseFloat(priceMatch[1].replace(',', '.'));
      }
    }

    if (!currentBasePrice || isNaN(currentBasePrice)) {
      currentBasePrice = 500; // –¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    }
  });

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω
  function testPriceCalculation() {
    console.log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Factory Method —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω:');

    const testCases = [
      { type: 'NO_DISCOUNT', basePrice: 1000, expected: 1000 },
      { type: 'CHILD_DISCOUNT', basePrice: 1000, expected: 500 },
      { type: 'STUDENT_DISCOUNT', basePrice: 1000, expected: 700 },
      { type: 'SENIOR_DISCOUNT', basePrice: 1000, expected: 800 }
    ];

    testCases.forEach(test => {
      const result = discountCalculator.calculatePrice(test.basePrice, test.type);
      console.log(`${test.type}: ${test.basePrice} -> ${result.finalPrice} (–æ–∂–∏–¥–∞–ª–æ—Å—å: ${test.expected})`);
    });
  }

  // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
  // testPriceCalculation();
</script>
</body>
</html>